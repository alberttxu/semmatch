ScriptName TemplateMatch_noGUI

### Before running this script, make sure:
#   1.  The working directory is set to where the navigator file is.
#           This can be done via:
#              Menubar->Script->Edit/Run one Line
#              In any of the 5 prompts, type UserSetDirectory and click Run.
#              Select the folder containing the navigator file.
#   2.  Save a template of a hole/pattern as a jpg image.
#         Crop a hole using ctrl+shift+drag,
#             and then select Menubar->Process-> Crop Image.
#         Then using the Edit/Run one Line prompt, run
#             SaveToOtherFile A JPG JPG T.jpg
#

reduction = 8
threshold = 0.8
currentNav = nav.nav
outputNav = newNav.nav
image = MMM.jpg
template = T.jpg
acquire = 1                                    # True = 1 ; False = 0
groupOption = 0
    #    0 = no groups
    #    1 = groups based on radius
    #    2 = all points as one group
    #    3 = specify a certain number of groups (k-means clustering)

If $acquire != 1 AND $acquire != 0
   Echo acquire should be either 1 or 0
   Exit
Endif

If $reduction == 1
   Echo  Can't reduce by a factor of $reduction. Use a higher number.
   Exit
Endif

## load and bin MMM map
ReportNavItem
If $RepVal5 != 2        # if not a map item
   Echo -> Not a map item, exit!
   Exit
EndIf
MAP = $navLabel
Echo Map Label: $MAP
SetUserSetting BufferToReadInto 16
SetUserSetting LoadMapsUnbinned 1
LoadNavMap
ReduceImage Q $reduction
Show Q

## make a jpeg image
SaveToOtherFile A JPG JPG $image
Echo saved $image

ReportOtherItem -1
newLabel = $navIntLabel + 1

RunInShell cmd /c " "semmatch" \
"--navfile" "$currentNav" \
"--reduction" "$reduction" \
"--image" "$image" \
"--template" "$template" \
"--mapLabel" "$MAP" \
"--newLabel" "$newLabel" \
"--threshold" "$threshold" \
"--groupOption" "$groupOption" \
"--output" "$outputNav" \
"--acquire" "$acquire" "

MergeNavFile $outputNav

Show Q
